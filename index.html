<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Boleto Conmemorativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CARGA DE FUENTE PERSONALIZADA -->
    <style>
        @font-face {
            font-family: 'Gazzetta-Custom';
            /* RUTA LOCAL PARA DESARROLLO: Asume que el archivo GazzettaMediumSlanted.otf está en el root de tu servidor. */
            src: url('/GazzettaMediumSlanted.otf') format('opentype'); 
            font-weight: 400;
            font-style: normal;
        }

        body {
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 250; /* Ajusta manualmente el peso si deseas un trazo más fino o grueso */
            font-size: 40px; /* Ajusta manualmente el tamaño si quieres un cuerpo más pequeño/grande */
            background-color: #80D8C2; /* Color verde esmeralda pastel */
            color: #000;
        }

        /* Usamos 'Gazzetta-Custom' para que el título use la fuente correcta */
        .gazzetta-medium-slanted {
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 400; /* Aplica el peso de la fuente */
        }

        .ticket-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: auto;
        }
        
        #baseImage {
            width: 100%;
            height: auto;
        }
        
        .shimmer {
            background: linear-gradient(-45deg, rgba(255, 255, 255, 0) 40%, rgba(255, 165, 0, 0.4) 50%, rgba(255, 255, 255, 0) 60%);
            background-size: 200% 200%;
            animation: shimmer 2.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .ticket-text {
            position: absolute;
            font-weight: bold;
            color: #2e5950; /* Color verde más oscuro */
            white-space: nowrap;
            font-style: normal;
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 230;
            transform-origin: left top; 
            /* Las coordenadas se aplicarán directamente en JavaScript para precisión */
        }
        
        #previewContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        
        #generatedTicketImage {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain; /* Evita que la imagen se estire */
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-emerald-200 text-black min-h-screen flex flex-col items-center p-4">

    <h1 class="text-3xl md:text-5xl gazzetta-medium-slanted text-center my-8">SWIFTIES CHIAPAS </h1>

    <div class="w-full max-w-2xl bg-black bg-opacity-50 p-6 rounded-lg shadow-xl mb-8">
        <div class="ticket-container">
            <!-- RUTA PARA USO EN DESARROLLO (IMAGEN DE IMAGUR CON CORS AMIGABLE) -->
            <!-- Usamos Imgur para desarrollo, pero las coordenadas son para 1378x647 -->
            <img id="baseImage" src="https://i.imgur.com/fwAcs1Q.jpeg" alt="Boleto base" class="w-full h-auto rounded-lg" crossorigin="anonymous">
            <div id="ticketOverlay"></div>
        </div>

        <div class="mt-8 space-y-4">
            <div>
                <label for="venue" class="block text-lg font-medium">Lugar</label>
                <select id="venue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    <option value="" disabled selected>Selecciona un lugar</option>
                    <option value="Cinepolis Poliforum">Cinepolis Poliforum</option>
                    <option value="Cinepolis Plaza Sol">Cinepolis Plaza Sol</option>
                    <option value="Cinepolis Paso Limón">Cinepolis Paso Limón</option>
                    <option value="Cinemex Ambar">Cinemex Ambar</option>
                    <option value="Cinemex Ambar Platino">Cinemex Ambar Platino</option>
                    <option value="Cinemex Galerias">Cinemex Galerias</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div id="otherVenueContainer" class="hidden">
                <label for="otherVenue" class="block text-lg font-medium">Escribe el lugar</label>
                <input type="text" id="otherVenue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" placeholder="Escribe aquí el lugar">
            </div>

            <div>
                <label for="fecha" class="block text-lg font-medium">Fecha</label>
                <select id="fecha" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    <option value="" disabled selected>Selecciona una fecha</option>
                    <option value="Oct 3">Octubre 3</option>
                    <option value="Oct 4">Octubre 4</option>
                    <option value="Oct 5">Octubre 5</option>
                </select>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="sala" class="block text-lg font-medium">Sala</label>
                    <select id="sala" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
                <div>
                    <label for="fila" class="block text-lg font-medium">Fila</label>
                    <select id="fila" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
                <div>
                    <label for="asiento" class="block text-lg font-medium">Asiento</label>
                    <select id="asiento" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
            </div>

            <button id="generateBtn" class="w-full mt-4 p-3 rounded-md bg-gray-500 text-white font-bold transition-colors duration-300 cursor-not-allowed" disabled>GENERAR</button>
        </div>
    </div>

    <div id="previewContainer" class="hidden">
        <h2 id="previewTitle" class="text-3xl text-white mb-4">Generando...</h2>
        <div id="loadingSpinner" class="loading-spinner"></div>
        <img id="generatedTicketImage" src="" alt="Boleto Generado" class="hidden">
        <div id="previewButtons" class="flex space-x-4 mt-4 hidden">
            <button id="downloadBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">DESCARGAR</button>
            <button id="closePreviewBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">CERRAR</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const venueSelect = document.getElementById('venue');
            const otherVenueContainer = document.getElementById('otherVenueContainer');
            const otherVenueInput = document.getElementById('otherVenue');
            const fechaSelect = document.getElementById('fecha');
            const salaSelect = document.getElementById('sala');
            const filaSelect = document.getElementById('fila');
            const asientoSelect = document.getElementById('asiento');
            const generateBtn = document.getElementById('generateBtn');
            const ticketOverlay = document.getElementById('ticketOverlay');
            const baseImage = document.getElementById('baseImage');

            const previewContainer = document.getElementById('previewContainer');
            const previewTitle = document.getElementById('previewTitle');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generatedTicketImage = document.getElementById('generatedTicketImage');
            const previewButtons = document.getElementById('previewButtons');
            const downloadBtn = document.getElementById('downloadBtn');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            
            let currentDownloadURL = '';
            let fieldsFilled = 0;

            // Dimensiones ORIGINALES de la imagen base (se usan para el cálculo de porcentaje en la vista en tiempo real)
            const ORIGINAL_IMAGE_WIDTH = 2407.9745;
            const ORIGINAL_IMAGE_HEIGHT = 1247.7159;

            // Dimensiones REALES de la imagen final (para el Canvas)
            const FINAL_IMAGE_WIDTH = 1378; 
            const FINAL_IMAGE_HEIGHT = 647; 

            // Coordenadas para la VISTA EN TIEMPO REAL (basado en la proporción original)
            const LIVE_COORDS = {
                venue: { x: 1410.00, y: 407.00, rotate: -3, size: 50.00 },
                fecha: { x: 1668.00, y: 581.60, size: 50.00 },
                sala: { x: 1393.00, y: 854.00, size: 51.00 },
                fila: { x: 1732.00, y: 859.00, size: 51.00 },
                asiento: { x: 2192.00, y: 843.50, size: 56.00 },
            };
            
            // Coordenadas ACTUALIZADAS para la IMAGEN FINAL GENERADA (ajustadas a la nueva resolución 1378x647)
            // Hemos usado el punto de inicio del mapa de imagen más un pequeño ajuste vertical/horizontal
            const FINAL_FONT_SCALE = 1.55; // Ajusta manualmente este factor para cambiar el tamaño final del texto en la imagen
            const LIVE_FONT_SCALE = 0.92; // Ajusta manualmente este factor si quieres que la vista previa sea más grande o más pequeña
            const FINAL_COORDS = {
// Basado en coords="813, 227" de la imagen 1378x647, con ajuste de posición y tamaño x2
venue:   { x: 813 + 10, y: 237 - 15, rotate: -3, size: 37.00 * FINAL_FONT_SCALE },

// Basado en coords="954, 311"
fecha:   { x: 954 + 10, y: 321 - 15, rotate: 0, size: 39.00 * FINAL_FONT_SCALE },

// Basado en coords="802, 461"
sala:    { x: 802 + 5,  y: 460 - 15, rotate: 0, size: 45.00 * FINAL_FONT_SCALE },

// Basado en coords="995, 459"
fila:    { x: 995 + 5,  y: 460 - 15, rotate: 0, size: 45.00 * FINAL_FONT_SCALE },

// Basado en coords="1229, 461"
asiento: { x: 1179 + 5, y: 460 - 15, rotate: 0, size: 45.00 * FINAL_FONT_SCALE },

            };


            
            // Populate dropdowns
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                salaSelect.appendChild(option);
            }

            for (let i = 0; i < 26; i++) {
                const letter = String.fromCharCode(65 + i);
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                filaSelect.appendChild(option);
            }

            for (let i = 0; i <= 40; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                asientoSelect.appendChild(option);
            }

            // Show/hide "Otro" venue field
            venueSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Otro') {
                    otherVenueContainer.classList.remove('hidden');
                } else {
                    otherVenueContainer.classList.add('hidden');
                }
                updateTicketPreview();
                checkForm();
            });

            // Update ticket preview on input change
            [venueSelect, otherVenueInput, fechaSelect, salaSelect, filaSelect, asientoSelect].forEach(element => {
                element.addEventListener('input', () => {
                    updateTicketPreview();
                    checkForm();
                });
            });

            function updateTicketPreview() {
                const venueValue = venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value;
                const ticketData = {
                    venue: venueValue.toUpperCase(),
                    fecha: fechaSelect.value.toUpperCase().replace('OCT', 'OCTUBRE'),
                    sala: salaSelect.value.toUpperCase(),
                    fila: filaSelect.value.toUpperCase(),
                    asiento: asientoSelect.value.toUpperCase(),
                };

                // Clear previous text
                ticketOverlay.innerHTML = '';
                fieldsFilled = 0;

                for (const key in ticketData) {
                    if (ticketData[key]) {
                        fieldsFilled++;
                        const textElement = document.createElement('div');
                        textElement.textContent = ticketData[key];
                        textElement.style.position = 'absolute';
                        textElement.style.color = '#2e5950';
                        textElement.style.fontFamily = 'Gazzetta-Custom, sans-serif';
                        textElement.style.fontVariationSettings = `'wght' 400`;
                        textElement.style.whiteSpace = 'nowrap';
                        textElement.style.fontStyle = 'normal';
                        
                        // CÁLCULO DE POSICIÓN Y TAMAÑO EN UNIDADES RESPONSIVAS (VW, %) usando LIVE_COORDS
                        const x = (LIVE_COORDS[key].x / ORIGINAL_IMAGE_WIDTH) * 100;
                        const y = (LIVE_COORDS[key].y / ORIGINAL_IMAGE_HEIGHT) * 100;
                        const size = (LIVE_COORDS[key].size / ORIGINAL_IMAGE_WIDTH) * 100 * LIVE_FONT_SCALE;

                        textElement.style.left = `${x}%`;
                        textElement.style.top = `${y}%`;
                        textElement.style.fontSize = `${size}vw`;

                        if (LIVE_COORDS[key].rotate) {
                           textElement.style.transformOrigin = 'left top';
                           textElement.style.transform = `rotate(${LIVE_COORDS[key].rotate}deg)`;
                        }

                        ticketOverlay.appendChild(textElement);
                    }
                }

                if (fieldsFilled > 0) {
                    baseImage.classList.add('shimmer');
                } else {
                    baseImage.classList.remove('shimmer');
                }
            }
            
            // Enable/disable generate button
            function checkForm() {
                const venueValue = venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value;
                const isFormComplete = venueValue && fechaSelect.value && salaSelect.value && filaSelect.value && asientoSelect.value;
                
                if (isFormComplete) {
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    generateBtn.classList.add('bg-orange-600', 'hover:bg-orange-700', 'cursor-pointer');
                } else {
                    generateBtn.disabled = true;
                    generateBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                    generateBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700', 'cursor-pointer');
                }
            }
            
            async function createTicketImage() {
                const canvas = document.createElement('canvas');
                const img = new Image(); // Usamos un nuevo objeto Image para asegurar el origen cruzado
                img.crossOrigin = 'anonymous'; 

                return new Promise((resolve, reject) => {
                    img.onload = () => {
                        // Usamos las dimensiones REALES de la imagen final
                        const originalWidth = FINAL_IMAGE_WIDTH;
                        const originalHeight = FINAL_IMAGE_HEIGHT;
                        canvas.width = originalWidth;
                        canvas.height = originalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Set text properties for final generation
                        ctx.fillStyle = '#2e5950';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'top';

                        // Usamos FINAL_COORDS para la generación
                        const textElements = [
                            { text: (venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value).toUpperCase(), x: FINAL_COORDS.venue.x, y: FINAL_COORDS.venue.y, rotate: FINAL_COORDS.venue.rotate, size: FINAL_COORDS.venue.size },
                            { text: fechaSelect.value.toUpperCase().replace('OCT', 'OCTUBRE'), x: FINAL_COORDS.fecha.x, y: FINAL_COORDS.fecha.y, rotate: FINAL_COORDS.fecha.rotate, size: FINAL_COORDS.fecha.size },
                            { text: salaSelect.value.toUpperCase(), x: FINAL_COORDS.sala.x, y: FINAL_COORDS.sala.y, rotate: FINAL_COORDS.sala.rotate, size: FINAL_COORDS.sala.size },
                            { text: filaSelect.value.toUpperCase(), x: FINAL_COORDS.fila.x, y: FINAL_COORDS.fila.y, rotate: FINAL_COORDS.fila.rotate, size: FINAL_COORDS.fila.size },
                            { text: asientoSelect.value.toUpperCase(), x: FINAL_COORDS.asiento.x, y: FINAL_COORDS.asiento.y, rotate: FINAL_COORDS.asiento.rotate, size: FINAL_COORDS.asiento.size },
                        ];

                        textElements.forEach(item => {
                            // Aplicar la fuente personalizada y el tamaño
                            ctx.font = `${item.size}px "Gazzetta-Custom", sans-serif`; 
                            ctx.save();
                            ctx.translate(item.x, item.y);
                            if (item.rotate) {
                                ctx.rotate(item.rotate * Math.PI / 180);
                            }
                            ctx.fillText(item.text, 0, 0);
                            ctx.restore();
                        });

                        resolve(canvas.toDataURL('image/jpeg', 0.9)); // Convert to JPG with 90% quality
                    };
                    img.onerror = (e) => {
                        console.error('Error al cargar la imagen base para Canvas:', e);
                        reject(new Error('No se pudo cargar la imagen base.'));
                    };
                    // Usamos la URL que tiene las dimensiones 1378x647
                    img.src = 'https://ts12swiftieschiapas.es/boletovacio.webp'; 
                });
            }

            // Generate button click
            generateBtn.addEventListener('click', async () => {
                // Show loading state
                previewContainer.style.display = 'flex';
                previewTitle.textContent = 'Generando...';
                loadingSpinner.classList.remove('hidden');
                generatedTicketImage.classList.add('hidden');
                previewButtons.classList.add('hidden');
                
                try {
                    const ticketDataURL = await createTicketImage();
                    currentDownloadURL = ticketDataURL;
                    generatedTicketImage.src = ticketDataURL;
                    
                    // Hide loading and show generated image
                    previewTitle.textContent = 'Vista Previa';
                    loadingSpinner.classList.add('hidden');
                    generatedTicketImage.classList.remove('hidden');
                    previewButtons.classList.remove('hidden');

                } catch (error) {
                    console.error('Error al generar el boleto:', error.message);
                    previewTitle.textContent = 'Error: No se pudo generar el boleto.';
                    loadingSpinner.classList.add('hidden');
                }
            });

            // Download button click
            downloadBtn.addEventListener('click', (event) => {
                event.preventDefault(); 
                if (currentDownloadURL) {
                    const link = document.createElement('a');
                    link.href = currentDownloadURL;
                    link.download = 'boletoswiftieschiapas.jpg'; // Save as JPG
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });

            // Close preview
            closePreviewBtn.addEventListener('click', () => {
                previewContainer.style.display = 'none';
            });

            // Initial checks
            updateTicketPreview();
            checkForm();
        });
    </script>
</body>
</html>
