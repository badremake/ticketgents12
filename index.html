<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Boleto Conmemorativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CARGA DE FUENTE PERSONALIZADA -->
    <!-- Asume que el archivo GazzettaMediumSlanted.otf está en el root de tu servidor. -->
    <style>
        @font-face {
            font-family: 'Gazzetta-Custom';
            src: url('./GazzettaMediumSlanted.otf') format('opentype');
            /* Agrega 'format('woff')' si tienes un archivo .woff para mejor compatibilidad */
            font-weight: 400;
            font-style: normal;
        }

        body {
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 400;
            background-color: #80D8C2; /* Color verde esmeralda pastel */
            color: #000;
        }

        /* Usamos 'Gazzetta-Custom' para que el título use la fuente correcta */
        .gazzetta-medium-slanted {
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 400; /* Aplica el peso de la fuente */
        }

        .ticket-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: auto;
        }
        
        #baseImage {
            width: 100%;
            height: auto;
            display: block;
        }

        #ticketOverlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        
        .shimmer {
            background: linear-gradient(-45deg, rgba(255, 255, 255, 0) 40%, rgba(255, 165, 0, 0.4) 50%, rgba(255, 255, 255, 0) 60%);
            background-size: 200% 200%;
            animation: shimmer 2.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .ticket-text {
            position: absolute;
            font-weight: bold;
            color: #2e5950; /* Color verde más oscuro */
            white-space: nowrap;
            font-style: normal;
            font-family: 'Gazzetta-Custom', sans-serif;
            font-variation-settings: 'wght' 400;
        }
        
        #previewContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        
        #generatedTicketImage {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain; /* Evita que la imagen se estire */
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-emerald-200 text-black min-h-screen flex flex-col items-center p-4">

    <h1 class="text-3xl md:text-5xl gazzetta-medium-slanted text-center my-8">TS12 RELEASE PARTY TICKET </h1>

    <div class="w-full max-w-2xl bg-black bg-opacity-50 p-6 rounded-lg shadow-xl mb-8">
        <div class="ticket-container">
            <!-- RUTA DE IMAGEN ALINEADA CON EL CÓDIGO LOCAL DEL USUARIO -->
            <img id="baseImage" src="./boletovacio.webp" alt="Boleto base" class="w-full h-auto rounded-lg" crossorigin="anonymous">
            <div id="ticketOverlay"></div>
        </div>

        <div class="mt-8 space-y-4">
            <div>
                <label for="venue" class="block text-sm font-medium">Lugar</label>
                <select id="venue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    <option value="" disabled selected>Selecciona un lugar</option>
                    <option value="Cinepolis Poliforum">Cinepolis Poliforum</option>
                    <option value="Cinepolis Plaza Sol">Cinepolis Plaza Sol</option>
                    <option value="Cinepolis Paso Limón">Cinepolis Paso Limón</option>
                    <option value="Cinemex Ambar">Cinemex Ambar</option>
                    <option value="Cinemex Ambar Platino">Cinemex Ambar Platino</option>
                    <option value="Cinemex Galerias">Cinemex Galerias</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div id="otherVenueContainer" class="hidden">
                <label for="otherVenue" class="block text-sm font-medium">Escribe el lugar</label>
                <input type="text" id="otherVenue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" placeholder="Escribe aquí el lugar">
            </div>

            <div>
                <label for="fecha" class="block text-sm font-medium">Fecha</label>
                <select id="fecha" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    <option value="" disabled selected>Selecciona una fecha</option>
                    <option value="Oct 3">Octubre 3</option>
                    <option value="Oct 4">Octubre 4</option>
                    <option value="Oct 5">Octubre 5</option>
                </select>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="sala" class="block text-sm font-medium">Sala</label>
                    <select id="sala" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
                <div>
                    <label for="fila" class="block text-sm font-medium">Fila</label>
                    <select id="fila" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
                <div>
                    <label for="asiento" class="block text-sm font-medium">Asiento</label>
                    <select id="asiento" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
                </div>
            </div>

            <button id="generateBtn" class="w-full mt-4 p-3 rounded-md bg-gray-500 text-white font-bold transition-colors duration-300 cursor-not-allowed" disabled>Generar</button>
        </div>
    </div>

    <div id="previewContainer" class="hidden">
        <h2 id="previewTitle" class="text-3xl text-white mb-4">Generando...</h2>
        <div id="loadingSpinner" class="loading-spinner"></div>
        <img id="generatedTicketImage" src="" alt="Boleto Generado" class="hidden">
        <div id="previewButtons" class="flex space-x-4 mt-4 hidden">
            <button id="downloadBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">Descargar</button>
            <button id="closePreviewBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">Cerrar</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const venueSelect = document.getElementById('venue');
            const otherVenueContainer = document.getElementById('otherVenueContainer');
            const otherVenueInput = document.getElementById('otherVenue');
            const fechaSelect = document.getElementById('fecha');
            const salaSelect = document.getElementById('sala');
            const filaSelect = document.getElementById('fila');
            const asientoSelect = document.getElementById('asiento');
            const generateBtn = document.getElementById('generateBtn');
            const ticketOverlay = document.getElementById('ticketOverlay');
            const baseImage = document.getElementById('baseImage');

            const previewContainer = document.getElementById('previewContainer');
            const previewTitle = document.getElementById('previewTitle');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generatedTicketImage = document.getElementById('generatedTicketImage');
            const previewButtons = document.getElementById('previewButtons');
            const downloadBtn = document.getElementById('downloadBtn');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            
            let currentDownloadURL = '';
            let fieldsFilled = 0;

            // Coordenadas fijas de la imagen final (en pixeles relativos al archivo base)
            const TICKET_LAYOUT = {
                venue: { x: 1410.0, y: 407.0, rotate: -3, size: 45.0 },
                fecha: { x: 1668.0, y: 581.6, rotate: 0, size: 45.0 },
                sala: { x: 1393.0, y: 854.0, rotate: 0, size: 55.0 },
                fila: { x: 1732.0, y: 859.0, rotate: 0, size: 55.0 },
                asiento: { x: 2132.0, y: 843.5, rotate: 0, size: 60.0 },
            };

            // Dimensiones de la imagen base para cálculos
            const IMAGE_WIDTH = 2407.9745;
            const IMAGE_HEIGHT = 1247.7159;
            
            // Populate dropdowns
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                salaSelect.appendChild(option);
            }

            for (let i = 0; i < 26; i++) {
                const letter = String.fromCharCode(65 + i);
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                filaSelect.appendChild(option);
            }

            for (let i = 0; i <= 40; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                asientoSelect.appendChild(option);
            }

            // Show/hide "Otro" venue field
            venueSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Otro') {
                    otherVenueContainer.classList.remove('hidden');
                } else {
                    otherVenueContainer.classList.add('hidden');
                }
                updateTicketPreview();
                checkForm();
            });

            // Update ticket preview on input change
            [venueSelect, otherVenueInput, fechaSelect, salaSelect, filaSelect, asientoSelect].forEach(element => {
                element.addEventListener('input', () => {
                    updateTicketPreview();
                    checkForm();
                });
            });

            function updateTicketPreview() {
                if (!baseImage.naturalWidth || !baseImage.naturalHeight) {
                    return;
                }

                const scaleX = baseImage.clientWidth / IMAGE_WIDTH;
                const scaleY = baseImage.clientHeight / IMAGE_HEIGHT;

                ticketOverlay.style.width = `${baseImage.clientWidth}px`;
                ticketOverlay.style.height = `${baseImage.clientHeight}px`;

                const venueValue = venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value;
                const ticketData = {
                    venue: venueValue.toUpperCase(),
                    fecha: fechaSelect.value.toUpperCase().replace('OCT', 'OCTUBRE'),
                    sala: salaSelect.value.toUpperCase(),
                    fila: filaSelect.value.toUpperCase(),
                    asiento: asientoSelect.value.toUpperCase(),
                };

                // Clear previous text
                ticketOverlay.innerHTML = '';
                fieldsFilled = 0;

                for (const key in ticketData) {
                    if (ticketData[key]) {
                        fieldsFilled++;
                        const layout = TICKET_LAYOUT[key];
                        const textElement = document.createElement('div');
                        textElement.textContent = ticketData[key];
                        textElement.className = `ticket-text ${key}`;
                        textElement.style.left = `${layout.x * scaleX}px`;
                        textElement.style.top = `${layout.y * scaleY}px`;
                        textElement.style.transformOrigin = 'left top';
                        textElement.style.transform = `rotate(${layout.rotate}deg)`;
                        textElement.style.fontSize = `${layout.size * ((scaleX + scaleY) / 2)}px`;

                        ticketOverlay.appendChild(textElement);
                    }
                }

                if (fieldsFilled > 0) {
                    baseImage.classList.add('shimmer');
                } else {
                    baseImage.classList.remove('shimmer');
                }
            }
            
            // Enable/disable generate button
            function checkForm() {
                const venueValue = venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value;
                const isFormComplete = venueValue && fechaSelect.value && salaSelect.value && filaSelect.value && asientoSelect.value;
                
                if (isFormComplete) {
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    generateBtn.classList.add('bg-orange-600', 'hover:bg-orange-700', 'cursor-pointer');
                } else {
                    generateBtn.disabled = true;
                    generateBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                    generateBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700', 'cursor-pointer');
                }
            }
            
            async function createTicketImage() {
                const canvas = document.createElement('canvas');
                // USAMOS EL ELEMENTO BASEIMAGE YA CARGADO EN EL DOM
                const img = baseImage;
                
                return new Promise((resolve, reject) => {
                    // Verificamos que la imagen esté lista. Si no lo está, intentamos forzar un 'onload'
                    if (img.complete && img.naturalHeight !== 0) {
                        drawOnCanvas(img, canvas, resolve);
                    } else {
                        img.onload = () => drawOnCanvas(img, canvas, resolve);
                        img.onerror = (e) => {
                            console.error('Error al cargar la imagen base:', e);
                            reject(new Error('No se pudo cargar la imagen base.'));
                        };
                    }
                });
            }

            function drawOnCanvas(img, canvas, resolve) {
                const originalWidth = img.naturalWidth;
                const originalHeight = img.naturalHeight;
                canvas.width = originalWidth;
                canvas.height = originalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Set text properties for final generation
                ctx.fillStyle = '#2e5950';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                const textElements = [
                    { text: (venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value).toUpperCase(), ...TICKET_LAYOUT.venue },
                    { text: fechaSelect.value.toUpperCase().replace('OCT', 'OCTUBRE'), ...TICKET_LAYOUT.fecha },
                    { text: salaSelect.value.toUpperCase(), ...TICKET_LAYOUT.sala },
                    { text: filaSelect.value.toUpperCase(), ...TICKET_LAYOUT.fila },
                    { text: asientoSelect.value.toUpperCase(), ...TICKET_LAYOUT.asiento },
                ];

                textElements.forEach(item => {
                    // Aplicar la fuente personalizada y el tamaño
                    ctx.font = `600 ${item.size}px "Gazzetta-Custom", sans-serif`; // Usamos sans-serif como fallback
                    ctx.save();
                    ctx.translate(item.x, item.y);
                    if (item.rotate) {
                        ctx.rotate(item.rotate * Math.PI / 180);
                    }
                    ctx.fillText(item.text, 0, 0);
                    ctx.restore();
                });

                resolve(canvas.toDataURL('image/jpeg', 0.9)); // Convert to JPG with 90% quality
            }

            // Generate button click
            generateBtn.addEventListener('click', async () => {
                // Show loading state
                previewContainer.style.display = 'flex';
                previewTitle.textContent = 'Generando...';
                loadingSpinner.classList.remove('hidden');
                generatedTicketImage.classList.add('hidden');
                previewButtons.classList.add('hidden');
                
                try {
                    const ticketDataURL = await createTicketImage();
                    currentDownloadURL = ticketDataURL;
                    generatedTicketImage.src = ticketDataURL;
                    
                    // Hide loading and show generated image
                    previewTitle.textContent = 'Vista Previa';
                    loadingSpinner.classList.add('hidden');
                    generatedTicketImage.classList.remove('hidden');
                    previewButtons.classList.remove('hidden');

                } catch (error) {
                    console.error('Error al generar el boleto:', error.message);
                    previewTitle.textContent = 'Error: No se pudo generar el boleto.';
                    loadingSpinner.classList.add('hidden');
                }
            });

            // Download button click
            downloadBtn.addEventListener('click', (event) => {
                event.preventDefault(); 
                if (currentDownloadURL) {
                    const link = document.createElement('a');
                    link.href = currentDownloadURL;
                    link.download = 'boletoswiftieschiapas.jpg'; // Save as JPG
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });

            // Close preview
            closePreviewBtn.addEventListener('click', () => {
                previewContainer.style.display = 'none';
            });

            // Initial checks
            if (baseImage.complete && baseImage.naturalWidth) {
                updateTicketPreview();
            } else {
                baseImage.addEventListener('load', updateTicketPreview);
            }
            checkForm();

            window.addEventListener('resize', updateTicketPreview);
        });
    </script>
</body>
</html>
