<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generador de Boleto Conmemorativo</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Fuente local OTF */
    @font-face {
      font-family: 'GazzettaMediumSlanted';
      src: url('./GazzettaMediumSlanted.otf') format('opentype');
      font-weight: 400;
      font-style: italic;
    }

    :root {
      --gazzetta: 'GazzettaMediumSlanted', system-ui, sans-serif;
    }

    body {
      font-family: var(--gazzetta);
      font-style: italic;
      font-weight: 400;
      background-color: #80D8C2;
      color: #000;
      font-synthesis: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .gazzetta-medium-slanted {
      font-family: var(--gazzetta);
      font-style: italic;
      font-weight: 400;
    }

    .ticket-text {
      position: absolute;
      color: #2e5950;
      white-space: nowrap;
      font-family: var(--gazzetta);
      font-style: italic;
      font-weight: 400;
    }

    #previewContainer {
      position: fixed; inset: 0;
      background-color: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 100;
    }

    #generatedTicketImage {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-emerald-200 text-black min-h-screen flex flex-col items-center p-4">

  <h1 class="text-3xl md:text-5xl gazzetta-medium-slanted text-center my-8">
    TS12 Release Party Ticket
  </h1>

  <div class="w-full max-w-2xl bg-black bg-opacity-50 p-6 rounded-lg shadow-xl mb-8">
    <div class="ticket-container">
      <img id="baseImage" src="https://ts12swiftieschiapas.es/ticketgents12/boletovacio.webp" alt="Boleto base" class="w-full h-auto rounded-lg">
      <div id="ticketOverlay"></div>
    </div>

    <div class="mt-8 space-y-4">
      <div>
        <label for="venue" class="block text-sm font-medium">Lugar</label>
        <select id="venue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
          <option value="" disabled selected>Selecciona un lugar</option>
          <option value="Cinepolis Poliforum">Cinepolis Poliforum</option>
          <option value="Cinepolis Plaza Sol">Cinepolis Plaza Sol</option>
          <option value="Cinepolis Paso Limón">Cinepolis Paso Limón</option>
          <option value="Cinemex Ambar">Cinemex Ambar</option>
          <option value="Cinemex Ambar Platino">Cinemex Ambar Platino</option>
          <option value="Cinemex Galerias">Cinemex Galerias</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div id="otherVenueContainer" class="hidden">
        <label for="otherVenue" class="block text-sm font-medium">Escribe el lugar</label>
        <input type="text" id="otherVenue" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" placeholder="Escribe aquí el lugar">
      </div>

      <div>
        <label for="fecha" class="block text-sm font-medium">Fecha</label>
        <select id="fecha" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
          <option value="" disabled selected>Selecciona una fecha</option>
          <option value="OCT 3">OCT 3</option>
          <option value="OCT 4">OCT 4</option>
          <option value="OCT 5">OCT 5</option>
        </select>
      </div>

      <div class="grid grid-cols-3 gap-4">
        <div>
          <label for="sala" class="block text-sm font-medium">Sala</label>
          <select id="sala" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
        </div>
        <div>
          <label for="fila" class="block text-sm font-medium">Fila</label>
          <select id="fila" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
        </div>
        <div>
          <label for="asiento" class="block text-sm font-medium">Asiento</label>
          <select id="asiento" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2"></select>
        </div>
      </div>

      <button id="generateBtn" class="w-full mt-4 p-3 rounded-md bg-gray-500 text-white font-bold transition-colors duration-300 cursor-not-allowed" disabled>
        Generar
      </button>
    </div>
  </div>

  <div id="previewContainer" class="hidden">
    <h2 id="previewTitle" class="text-3xl text-white mb-4">Generando...</h2>
    <div id="loadingSpinner" class="loading-spinner"></div>
    <img id="generatedTicketImage" src="" alt="Boleto Generado" class="hidden">
    <div id="previewButtons" class="flex space-x-4 mt-4 hidden">
      <button id="downloadBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">Descargar</button>
      <button id="closePreviewBtn" class="p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold">Cerrar</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const venueSelect       = document.getElementById('venue');
      const otherVenueContainer = document.getElementById('otherVenueContainer');
      const otherVenueInput   = document.getElementById('otherVenue');
      const fechaSelect       = document.getElementById('fecha');
      const salaSelect        = document.getElementById('sala');
      const filaSelect        = document.getElementById('fila');
      const asientoSelect     = document.getElementById('asiento');
      const generateBtn       = document.getElementById('generateBtn');
      const ticketOverlay     = document.getElementById('ticketOverlay');
      const baseImage         = document.getElementById('baseImage');

      const previewContainer  = document.getElementById('previewContainer');
      const previewTitle      = document.getElementById('previewTitle');
      const loadingSpinner    = document.getElementById('loadingSpinner');
      const generatedTicketImage = document.getElementById('generatedTicketImage');
      const previewButtons    = document.getElementById('previewButtons');
      const downloadBtn       = document.getElementById('downloadBtn');
      const closePreviewBtn   = document.getElementById('closePreviewBtn');

      let currentDownloadURL = '';

      // Poblar selects
      for (let i = 1; i <= 30; i++) {
        salaSelect.innerHTML += `<option value="${i}">${i}</option>`;
      }
      for (let i = 0; i < 26; i++) {
        const l = String.fromCharCode(65+i);
        filaSelect.innerHTML += `<option value="${l}">${l}</option>`;
      }
      for (let i = 0; i <= 40; i++) {
        asientoSelect.innerHTML += `<option value="${i}">${i}</option>`;
      }

      // Mostrar campo "Otro"
      venueSelect.addEventListener('change', () => {
        otherVenueContainer.classList.toggle('hidden', venueSelect.value !== 'Otro');
        checkForm();
      });

      [venueSelect, otherVenueInput, fechaSelect, salaSelect, filaSelect, asientoSelect].forEach(el=>{
        el.addEventListener('input', checkForm);
      });

      function checkForm() {
        const venueValue = venueSelect.value === 'Otro' ? otherVenueInput.value : venueSelect.value;
        const complete = venueValue && fechaSelect.value && salaSelect.value && filaSelect.value && asientoSelect.value;
        generateBtn.disabled = !complete;
        generateBtn.className = complete
          ? "w-full mt-4 p-3 rounded-md bg-orange-600 hover:bg-orange-700 transition-colors duration-300 text-white font-bold"
          : "w-full mt-4 p-3 rounded-md bg-gray-500 text-white font-bold transition-colors duration-300 cursor-not-allowed";
      }

      async function ensureFontLoaded() {
        await document.fonts.load('italic 400 40px GazzettaMediumSlanted');
        await document.fonts.ready;
      }

      async function createTicketImage() {
        await ensureFontLoaded();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = "https://i.ibb.co/232Vhy8n/Artboard-2.webp";

        return new Promise((resolve, reject) => {
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            ctx.fillStyle = '#2e5950';
            ctx.font = 'italic 400 50px GazzettaMediumSlanted';

            ctx.fillText("BOLETO DEMO", 200, 200);

            resolve(canvas.toDataURL('image/jpeg', 0.9));
          };
          img.onerror = () => reject("Error al cargar imagen base");
        });
      }

      generateBtn.addEventListener('click', async () => {
        previewContainer.style.display = 'flex';
        previewTitle.textContent = 'Generando...';
        loadingSpinner.classList.remove('hidden');
        generatedTicketImage.classList.add('hidden');
        previewButtons.classList.add('hidden');

        try {
          const ticketDataURL = await createTicketImage();
          currentDownloadURL = ticketDataURL;
          generatedTicketImage.src = ticketDataURL;
          previewTitle.textContent = 'Vista Previa';
          loadingSpinner.classList.add('hidden');
          generatedTicketImage.classList.remove('hidden');
          previewButtons.classList.remove('hidden');
        } catch (e) {
          previewTitle.textContent = 'Error';
          console.error(e);
        }
      });

      downloadBtn.addEventListener('click', () => {
        if (currentDownloadURL) {
          const a = document.createElement('a');
          a.href = currentDownloadURL;
          a.download = 'boleto.jpg';
          a.click();
        }
      });

      closePreviewBtn.addEventListener('click', ()=> {
        previewContainer.style.display = 'none';
      });
    });
  </script>
</body>
</html>
